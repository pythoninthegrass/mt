version: "3.0"

env:
  PYTHONPATH: "{{.ROOT_DIR}}"

vars:
  BENCH_ROOT: "/tmp/mt-bench"
  BENCH_LIBRARY: "{{.BENCH_ROOT}}/library"
  BENCH_DB: "{{.BENCH_ROOT}}/mt.db"

tasks:
  make:shape:
    desc: "Generate shape-only synthetic library (41k tiny files)"
    cmds:
      - mkdir -p {{.BENCH_ROOT}}
      - uv run python tests/bench/make_synth_library.py --out-root {{.BENCH_LIBRARY}} --tracks 41000 --mode shape {{.CLI_ARGS}}

  make:clone:
    desc: "Generate clone-based synthetic library (requires --seed-dir)"
    cmds:
      - mkdir -p {{.BENCH_ROOT}}
      - uv run python tests/bench/make_synth_library.py --out-root {{.BENCH_LIBRARY}} --tracks 41000 --mode clone --seed-dir ~/Music/Media.localized {{.CLI_ARGS}}

  make:pathological:
    desc: "Generate pathological edge case dataset"
    cmds:
      - mkdir -p {{.BENCH_ROOT}}
      - uv run python tests/bench/make_synth_library.py --out-root {{.BENCH_LIBRARY}} --mode pathological {{.CLI_ARGS}}

  scan:initial:
    desc: "Benchmark initial import (fresh DB)"
    cmds:
      - rm -f {{.BENCH_DB}}
      - uv run python tests/bench/bench_scan.py --library-root {{.BENCH_LIBRARY}} --db-path {{.BENCH_DB}} --scenario initial {{.CLI_ARGS}}

  scan:noop:
    desc: "Benchmark no-op rescan (unchanged library)"
    cmds:
      - uv run python tests/bench/bench_scan.py --library-root {{.BENCH_LIBRARY}} --db-path {{.BENCH_DB}} --scenario noop {{.CLI_ARGS}}

  scan:delta:
    desc: "Benchmark delta rescan (1% changes)"
    cmds:
      - uv run python tests/bench/bench_scan.py --library-root {{.BENCH_LIBRARY}} --db-path {{.BENCH_DB}} --scenario delta --delta-add 200 --delta-touch 200 --delta-delete 10 {{.CLI_ARGS}}

  scan:full:
    desc: "Run complete benchmark pipeline (generate + verify + benchmark all scenarios)"
    cmds:
      # 1. Generate clone dataset
      - task: make:clone

      # 2. Verify files created
      - echo "Verifying file count..."
      - |
        FILE_COUNT=$(find {{.BENCH_LIBRARY}} -type f | wc -l | tr -d ' ')
        echo "Files created: $FILE_COUNT"
        if [ "$FILE_COUNT" -ne "41000" ]; then
          echo "ERROR: Expected 41000 files, got $FILE_COUNT"
          exit 1
        fi

      # 3. Check disk usage
      - echo "Checking disk usage..."
      - du -sh {{.BENCH_LIBRARY}}

      # 4. Run all benchmark scenarios
      - task: scan:initial
      - task: scan:noop
      - task: scan:delta

      # Note: cleanup is manual via `task bench:clean`

  zig:walk:
    desc: "Benchmark Zig traversal ceiling"
    cmds:
      - uv run python tests/bench/bench_zig_walk.py --library-root {{.BENCH_LIBRARY}} --iterations 5 {{.CLI_ARGS}}

  clean:
    desc: "Remove benchmark artifacts"
    cmds:
      - rm -rf {{.BENCH_ROOT}}

  logs:tail:
    desc: "Tail benchmark logs (use Ctrl+C to exit)"
    cmds:
      - tail -f /tmp/mt-bench/logs/*.log

  logs:list:
    desc: "List available benchmark logs"
    cmds:
      - ls -lht /tmp/mt-bench/logs/

  logs:view:
    desc: "View latest benchmark log (use LOG_NAME to specify)"
    cmds:
      - |
        if [ -z "{{.LOG_NAME}}" ]; then
          # Show latest log
          LATEST=$(ls -t /tmp/mt-bench/logs/*.log 2>/dev/null | head -1)
          if [ -n "$LATEST" ]; then
            echo "Viewing: $LATEST"
            cat "$LATEST"
          else
            echo "No logs found"
          fi
        else
          # Show specific log
          cat /tmp/mt-bench/logs/{{.LOG_NAME}}
        fi

  results:csv:
    desc: "View benchmark results CSV"
    cmds:
      - |
        if [ -f "/tmp/mt-bench/benchmark_results.csv" ]; then
          echo "Benchmark Results:"
          echo "================="
          column -t -s',' /tmp/mt-bench/benchmark_results.csv
        else
          echo "No results CSV found. Run benchmarks first."
        fi

  results:summary:
    desc: "View one-line summaries from all logs"
    cmds:
      - |
        echo "Benchmark Summaries:"
        echo "===================="
        grep "SUMMARY:" /tmp/mt-bench/logs/*.log 2>/dev/null | sed 's/.*INFO - //' || echo "No summaries found. Run benchmarks first."
