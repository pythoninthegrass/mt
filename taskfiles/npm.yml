version: "3.0"

set: ['e', 'u', 'pipefail']
shopt: ['globstar']

env:
  NPM_CACHE_DIR: "{{.ROOT_DIR}}/.cache/npm"

vars:
  FRONTEND_DIR: "app/frontend"

tasks:
  install:
    desc: "Install npm dependencies"
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - npm install
    sources:
      - "{{.ROOT_DIR}}/{{.FRONTEND_DIR}}/package.json"
    generates:
      - "{{.ROOT_DIR}}/{{.FRONTEND_DIR}}/node_modules/**/*"
    status:
      - test -d "{{.ROOT_DIR}}/{{.FRONTEND_DIR}}/node_modules"
    silent: true

  ci:
    desc: "Clean install npm dependencies (CI mode)"
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - npm ci

  update:
    desc: "Update npm dependencies"
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - npm update

  outdated:
    desc: "Check for outdated dependencies"
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - npm outdated || true
    silent: true

  audit:
    desc: "Run security audit"
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - npm audit

  audit-fix:
    desc: "Fix security vulnerabilities"
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - npm audit fix

  clean:
    desc: "Clean npm artifacts"
    cmds:
      - rm -rf {{.ROOT_DIR}}/{{.FRONTEND_DIR}}/node_modules
      - rm -rf {{.ROOT_DIR}}/.cache/npm
    silent: true

  cache-clean:
    desc: "Clean npm cache"
    cmds:
      - npm cache clean --force
    silent: true

  list:
    desc: "List installed packages"
    dir: "{{.FRONTEND_DIR}}"
    cmds:
      - npm list --depth=0
    silent: true

  check-deps:
    desc: "Check if npm is installed"
    cmds:
      - |
        echo "Checking npm dependencies..."
        if ! command -v npm &> /dev/null; then
          echo "npm not found. Install Node.js from https://nodejs.org"
          exit 1
        fi
        echo "npm version: $(npm --version)"
        echo "node version: $(node --version)"
    silent: true

  test:e2e:
    desc: "Run Playwright E2E tests (use -- webkit|chromium|firefox to select browser)"
    deps: [install]
    dir: "{{.ROOT_DIR}}/{{.FRONTEND_DIR}}"
    cmds:
      - |
        case "{{.CLI_ARGS}}" in
          webkit)
            npx playwright test --project=webkit
            ;;
          chromium)
            npx playwright test --project=chromium
            ;;
          firefox)
            npx playwright test --project=firefox
            ;;
          *)
            npx playwright test {{.CLI_ARGS}}
            ;;
        esac

  test:e2e:ui:
    desc: "Run Playwright E2E tests in UI mode"
    deps: [install]
    dir: "{{.ROOT_DIR}}/{{.FRONTEND_DIR}}"
    cmds:
      - npx playwright test --ui {{.CLI_ARGS}}
