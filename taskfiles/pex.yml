version: "3.0"

set: ['e', 'u', 'pipefail']
shopt: ['globstar']

vars:
  STAGING_DIR: "/tmp/mt-pex-staging"
  SIDECAR_DIR: "{{.ROOT_DIR}}/src-tauri/bin"
  BACKEND_DIR: "{{.ROOT_DIR}}/backend"
  MACOS_ARM64_TARGET: "aarch64-apple-darwin"
  MACOS_X64_TARGET: "x86_64-apple-darwin"
  PYTHON_VERSION: "3.12"
  SIDECAR_HOST: '{{.SIDECAR_HOST | default "127.0.0.1"}}'
  SIDECAR_PORT: '{{.SIDECAR_PORT | default "8765"}}'
  # Dependencies required by the mt backend sidecar
  PEX_DEPS: >-
    fastapi
    uvicorn
    pydantic
    websockets

tasks:
  printenv:
    desc: "Print environment variables"
    cmds:
      - |
        echo "PATH={{.PATH}}"
        echo "pex: $(command -v pex || echo 'not found')"
    silent: true

  info:
    desc: "Show PEX build configuration"
    cmds:
      - |
        cat << EOF
        PEX SCIE Build Configuration:
          Staging Directory: {{.STAGING_DIR}}
          Sidecar Directory: {{.SIDECAR_DIR}}
          Python Version: {{.PYTHON_VERSION}}

        Available targets:
          - build:arm64     Build PEX sidecar for Apple Silicon
          - build           Build PEX sidecar for current arch
          - stage           Stage app files for PEX build
          - clean           Clean staging directory

        Dependencies:
          {{.PEX_DEPS}}
        EOF
    silent: true

  _stage:
    internal: true
    desc: "Stage backend files for PEX build (excludes build artifacts)"
    cmds:
      - |
        echo "Staging backend files..."
        rm -rf {{.STAGING_DIR}}
        mkdir -p {{.STAGING_DIR}}/backend
        cp {{.BACKEND_DIR}}/__init__.py {{.STAGING_DIR}}/backend/
        cp {{.BACKEND_DIR}}/main.py {{.STAGING_DIR}}/backend/
        [ -d {{.BACKEND_DIR}}/models ] && cp -r {{.BACKEND_DIR}}/models {{.STAGING_DIR}}/backend/ || true
        [ -d {{.BACKEND_DIR}}/routes ] && cp -r {{.BACKEND_DIR}}/routes {{.STAGING_DIR}}/backend/ || true
        [ -d {{.BACKEND_DIR}}/services ] && cp -r {{.BACKEND_DIR}}/services {{.STAGING_DIR}}/backend/ || true
        echo "Staged to {{.STAGING_DIR}}"

  stage:
    desc: "Stage app files for PEX build"
    cmds:
      - task: _stage

  _build:
    internal: true
    desc: "Internal task to build PEX SCIE"
    vars:
      OUTPUT_NAME: '{{.OUTPUT_NAME | default "main"}}'
    deps:
      - _stage
    cmds:
      - |
        echo "Building PEX SCIE..."
        cd {{.STAGING_DIR}} && pex \
          {{.PEX_DEPS}} \
          -P backend \
          -e backend.main \
          --scie eager \
          --scie-only \
          --scie-pbs-stripped \
          --scie-python-version {{.PYTHON_VERSION}} \
          -o {{.SIDECAR_DIR}}/{{.OUTPUT_NAME}}
        echo "Built: {{.SIDECAR_DIR}}/{{.OUTPUT_NAME}}"
        ls -lh {{.SIDECAR_DIR}}/{{.OUTPUT_NAME}}

  build:
    desc: "Build PEX sidecar for current architecture"
    vars:
      CURRENT_TARGET: '{{if eq ARCH "arm64"}}{{.MACOS_ARM64_TARGET}}{{else}}{{.MACOS_X64_TARGET}}{{end}}'
    cmds:
      - task: _build
        vars:
          OUTPUT_NAME: "main-{{.CURRENT_TARGET}}"
    sources:
      - "{{.BACKEND_DIR}}/**/*.py"

  build:arm64:
    desc: "Build PEX sidecar for Apple Silicon (arm64)"
    cmds:
      - task: _build
        vars:
          OUTPUT_NAME: "main-{{.MACOS_ARM64_TARGET}}"
    sources:
      - "{{.BACKEND_DIR}}/**/*.py"

  build:x64:
    desc: "Build PEX sidecar for Intel (x86_64)"
    cmds:
      - |
        echo "Note: Cross-platform PEX builds require --scie-platform flag"
        echo "Building for x64..."
        task: _stage
        cd {{.STAGING_DIR}} && pex \
          {{.PEX_DEPS}} \
          -P backend \
          -e backend.main \
          --scie eager \
          --scie-only \
          --scie-pbs-stripped \
          --scie-python-version {{.PYTHON_VERSION}} \
          --scie-platform macos-x86_64 \
          -o {{.SIDECAR_DIR}}/main-{{.MACOS_X64_TARGET}}
    sources:
      - "{{.BACKEND_DIR}}/**/*.py"

  clean:
    desc: "Clean PEX staging directory"
    cmds:
      - rm -rf {{.STAGING_DIR}}
      - echo "Cleaned staging directory"
    silent: true

  clean:sidecar:
    desc: "Clean PEX sidecar binaries"
    cmds:
      - rm -f {{.SIDECAR_DIR}}/main
      - rm -f {{.SIDECAR_DIR}}/main-{{.MACOS_ARM64_TARGET}}
      - rm -f {{.SIDECAR_DIR}}/main-{{.MACOS_X64_TARGET}}
      - echo "Cleaned sidecar binaries"
    silent: true

  check-deps:
    desc: "Check if PEX dependencies are installed"
    cmds:
      - |
        echo "Checking PEX dependencies..."
        missing=0

        if ! command -v pex &> /dev/null; then
          echo "pex not found. Install with: uv pip install pex"
          missing=1
        else
          echo "pex version: $(pex --version)"
        fi

        if [[ $missing -eq 0 ]]; then
          echo "All dependencies satisfied"
        else
          exit 1
        fi
    silent: true

  test:
    desc: "Test PEX sidecar runs correctly"
    cmds:
      - |
        echo "Testing PEX sidecar..."
        MT_API_PORT={{.SIDECAR_PORT}} {{.SIDECAR_DIR}}/main-{{.MACOS_ARM64_TARGET}} &
        PID=$!
        sleep 3
        # Poll health endpoint
        for i in {1..10}; do
          if curl -sf http://{{.SIDECAR_HOST}}:{{.SIDECAR_PORT}}/api/health > /dev/null 2>&1; then
            echo "Server responding OK on port {{.SIDECAR_PORT}}"
            kill $PID 2>/dev/null
            exit 0
          fi
          echo "Waiting for server... ($i/10)"
          sleep 1
        done
        echo "Server not responding after 10 attempts"
        kill $PID 2>/dev/null
        exit 1
    preconditions:
      - test -f "{{.SIDECAR_DIR}}/main-{{.MACOS_ARM64_TARGET}}"
    silent: true
    ignore_error: true
