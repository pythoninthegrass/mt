version: "3.0"

set: ['e', 'u', 'pipefail']
shopt: ['globstar']

vars:
  STAGING_DIR: "/tmp/mt-pex-staging"
  SIDECAR_DIR: "{{.ROOT_DIR}}/src-tauri/bin"
  MACOS_ARM64_TARGET: "aarch64-apple-darwin"
  MACOS_X64_TARGET: "x86_64-apple-darwin"
  PYTHON_VERSION: "3.12"
  # Dependencies required by the mt backend sidecar
  PEX_DEPS: >-
    aiosqlite
    certifi
    eliot
    eliot-tree
    fastapi
    httpx
    lyricsgenius
    mutagen
    python-decouple
    uvicorn
    websockets

tasks:
  printenv:
    desc: "Print environment variables"
    cmds:
      - |
        echo "PATH={{.PATH}}"
        echo "pex: $(command -v pex || echo 'not found')"
    silent: true

  info:
    desc: "Show PEX build configuration"
    cmds:
      - |
        cat << EOF
        PEX SCIE Build Configuration:
          Staging Directory: {{.STAGING_DIR}}
          Sidecar Directory: {{.SIDECAR_DIR}}
          Python Version: {{.PYTHON_VERSION}}

        Available targets:
          - build:arm64     Build PEX sidecar for Apple Silicon
          - build           Build PEX sidecar for current arch
          - stage           Stage app files for PEX build
          - clean           Clean staging directory

        Dependencies:
          {{.PEX_DEPS}}
        EOF
    silent: true

  _stage:
    internal: true
    desc: "Stage backend files for PEX build (excludes build artifacts)"
    cmds:
      - |
        echo "Staging backend files..."
        rm -rf {{.STAGING_DIR}}
        mkdir -p {{.STAGING_DIR}}/backend
        cp {{.ROOT_DIR}}/backend/__init__.py {{.STAGING_DIR}}/backend/
        cp {{.ROOT_DIR}}/backend/main.py {{.STAGING_DIR}}/backend/
        [ -d {{.ROOT_DIR}}/backend/api ] && cp -r {{.ROOT_DIR}}/backend/api {{.STAGING_DIR}}/backend/ || true
        [ -d {{.ROOT_DIR}}/backend/core ] && cp -r {{.ROOT_DIR}}/backend/core {{.STAGING_DIR}}/backend/ || true
        echo "Staged to {{.STAGING_DIR}}"

  stage:
    desc: "Stage app files for PEX build"
    cmds:
      - task: _stage

  _build:
    internal: true
    desc: "Internal task to build PEX SCIE"
    vars:
      OUTPUT_NAME: '{{.OUTPUT_NAME | default "main"}}'
    deps:
      - _stage
    cmds:
      - |
        echo "Building PEX SCIE..."
        cd {{.STAGING_DIR}} && pex \
          {{.PEX_DEPS}} \
          -P backend \
          -e backend.main \
          --scie eager \
          --scie-only \
          --scie-pbs-stripped \
          --scie-python-version {{.PYTHON_VERSION}} \
          -o {{.SIDECAR_DIR}}/{{.OUTPUT_NAME}}
        echo "Built: {{.SIDECAR_DIR}}/{{.OUTPUT_NAME}}"
        ls -lh {{.SIDECAR_DIR}}/{{.OUTPUT_NAME}}

  build:
    desc: "Build PEX sidecar for current architecture"
    vars:
      CURRENT_TARGET: '{{if eq ARCH "arm64"}}{{.MACOS_ARM64_TARGET}}{{else}}{{.MACOS_X64_TARGET}}{{end}}'
    cmds:
      - task: _build
        vars:
          OUTPUT_NAME: "main-{{.CURRENT_TARGET}}"
    sources:
      - "{{.ROOT_DIR}}/backend/**/*.py"

  build:arm64:
    desc: "Build PEX sidecar for Apple Silicon (arm64)"
    cmds:
      - task: _build
        vars:
          OUTPUT_NAME: "main-{{.MACOS_ARM64_TARGET}}"
    sources:
      - "{{.ROOT_DIR}}/backend/**/*.py"

  build:x64:
    desc: "Build PEX sidecar for Intel (x86_64)"
    cmds:
      - |
        echo "Note: Cross-platform PEX builds require --scie-platform flag"
        echo "Building for x64..."
        task: _stage
        cd {{.STAGING_DIR}} && pex \
          {{.PEX_DEPS}} \
          -P backend \
          -e backend.main \
          --scie eager \
          --scie-only \
          --scie-pbs-stripped \
          --scie-python-version {{.PYTHON_VERSION}} \
          --scie-platform macos-x86_64 \
          -o {{.SIDECAR_DIR}}/main-{{.MACOS_X64_TARGET}}
    sources:
      - "{{.ROOT_DIR}}/backend/**/*.py"

  clean:
    desc: "Clean PEX staging directory"
    cmds:
      - rm -rf {{.STAGING_DIR}}
      - echo "Cleaned staging directory"
    silent: true

  clean:sidecar:
    desc: "Clean PEX sidecar binaries"
    cmds:
      - rm -f {{.SIDECAR_DIR}}/main
      - rm -f {{.SIDECAR_DIR}}/main-{{.MACOS_ARM64_TARGET}}
      - rm -f {{.SIDECAR_DIR}}/main-{{.MACOS_X64_TARGET}}
      - echo "Cleaned sidecar binaries"
    silent: true

  check-deps:
    desc: "Check if PEX dependencies are installed"
    cmds:
      - |
        echo "Checking PEX dependencies..."
        missing=0

        if ! command -v pex &> /dev/null; then
          echo "pex not found. Install with: uv pip install pex"
          missing=1
        else
          echo "pex version: $(pex --version)"
        fi

        if [[ $missing -eq 0 ]]; then
          echo "All dependencies satisfied"
        else
          exit 1
        fi
    silent: true

  test:
    desc: "Test PEX sidecar runs correctly"
    cmds:
      - |
        echo "Testing PEX sidecar..."
        {{.SIDECAR_DIR}}/main-{{.MACOS_ARM64_TARGET}} &
        PID=$!
        sleep 5
        if curl -s http://localhost:8080/ > /dev/null; then
          echo "Server responding OK"
          curl -s -X POST http://localhost:8080/shutdown
        else
          echo "Server not responding"
          kill $PID 2>/dev/null
          exit 1
        fi
    preconditions:
      - test -f "{{.SIDECAR_DIR}}/main-{{.MACOS_ARM64_TARGET}}"
    silent: true
    ignore_error: true
